{% extends 'base.html' %}

 {% block content %}
<h1>
    Your Messages, {{current_user.username}}
    puzzle_id:{{puzzle_id}}
    
    
</h1>
<!-- personal note modal -->
<div class="modal fade" id="personalNoteModal" tabindex="-1" aria-labelledby="personalNoteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="personalNoteLabel">Personal Note</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="{{ url_for('request_action') }}" method="POST">
          <div class="mb-3">
            <label for="recipient-name" class="col-form-label">Recipient:</label>
            <input type="text" class="form-control" id="recipientName" name="recipient_name" readonly>
          </div>
          <div class="mb-3">
            <label for="personalNote" class="col-form-label">Message:</label>
            <textarea class="form-control" id="personalNote" name="personal_note"></textarea>
          </div>
          <input type="hidden" id="actionType" name="action">
          <input type="hidden" id="requester" name="requester">
          <input type="hidden" id="puzzleId" name="puzzle_id">
          <button type="submit" class="btn btn-primary" >Send Message</button>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        
        
      </div>
    </div>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="confirmDeleteModalLabel">Confirm</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this message?
      </div>
      <form action="{{ url_for('delete_message')}}" method="POST">
          
          <input type="hidden" id="itemId" name="item_id">
          <button type="submit" class="btn btn-danger">Confirm Delete</button>
      </form>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
       
      </div>
    </div>
  </div>
</div>


<section >
      
    <div class="container py-5 ">
  
      <div class="row">
  
        <div class="col-md-6 col-lg-5 col-xl-4 mb-4 mb-md-0">
  
          <h5 class="font-weight-bold mb-3 text-center text-lg-start">Member</h5>
          
          <div class="card ">
            
            <div class="card-body">
              
              <ul class="list-unstyled mb-0">
                {% if message_senders %}
                    {% for message_sender in message_senders %}
                   
                        {% set sender = message_sender.sender %}
                        {% set unread_count = message_sender.unread_count %}
                        {% set puzzles = message_sender.puzzles %}
                      
                        {% if not sender.id == current_user.id%}
                        
                <li class="p-2 border-bottom bg-body-tertiary">
         
                    <div class="d-flex flex-row">
                       
                      <img src="{{ sender.create_avatar(128) }}" alt="avatar"
                        class="rounded-circle d-flex align-self-center me-3 shadow-1-strong" width="60">
                      <div class="pt-1">
                        <p class="fw-bold mb-0">{{ sender.username }}</p>
                        <p class="fw-bold mb-0">{{ message_sender.username }}</p>
                        {% if unread_count > 0 %}
                        <span class="badge bg-danger" id="unread-count-badge">{{ unread_count }}</span>
                        {% endif %}
                        
                      </div>
                     
                    </div>
                    <ul class="list-unstyled">
                      {% for puzzle in puzzles %}
                        <li>
                    
                    <a href="/messages?recipient_id={{sender.id}}&puzzle_id={{puzzle.id}}" class="d-flex justify-content-between">
                      
                     
                    <div class="d-flex flex-row">
                      <p class="fw-bold mb-0">{{ puzzle.title }}</p>
                  </div>
                </a>
              
              </li>
              {% endfor %}
                  
                </li>
                        {% endif %}
                {% endfor %}
            {% else %}
                <p>You have no messages yet.</p>
            {% endif %}
                

              </ul>
  
            </div>
          </div>
  
        </div>
    
       
        <div class="col-md-6 col-lg-7 col-xl-8">
          <div data-mdb-perfect-scrollbar-init style="position: relative; height: 400px; overflow: auto;">
            <ul class="list-unstyled">
              
              {% if recipient and puzzle_id%}
                {% if conversation %}
                    {% for message in conversation%}
                        {% if message.author.username != current_user.username%}
              <li class="d-flex justify-content-between mb-4">
                <div class="card w-100 {% if not message.is_read and message.recipient_owner_id == current_user.id%}unread{%endif%}" data-message-id="{{message.id}}">
                  Message ID: {{message.id}}
                  <div class="card-header d-flex justify-content-between p-3">
                    <p class="fw-bold mb-0">{{message.author.username}}</p>
                    <p class="small text-muted">{{message.puzzle.title}}</p>
                    <p class="text-muted small mb-0"><i class="far fa-clock"></i> {{message.timestamp}}</p>
                    
                    <div class="pt-1">
                        <!-- <p class="small text-muted mb-1">Just now</p> -->
                      {% if not message.is_read and message.recipient_owner_id == current_user.id%}
                      <span class="unread-indicator badge bg-danger float-end">unread</span>
                      {%endif%}
                    </div>
                  </div>
                  <div class="card-body">
                    <p class="mb-0">
                      {{message.content}}
                    </p>
                    
                   
                    {%if message.id == last_message_ids[message.puzzle_id] and current_user.id == message.puzzle.user_id and message.puzzle.is_requested %}
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#personalNoteModal" data-action="approve" data-requester="{% if message.author.username == current_user.username %}{{message.recipient.username}}{% else %}{{message.author.username}}{%endif%}" data-puzzle-id="{{ message.puzzle.id }}" data-recipient-name="{{message.author.username}}">Approve</button>
                    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#personalNoteModal" data-action="decline" data-requester="{% if message.author.username == current_user.username %}{{message.recipient.username}}{% else %}{{message.author.username}}{%endif%}" data-puzzle-id="{{ message.puzzle.id }}" data-recipient-name="{{message.author.username}}">Decline</button> 
                    {% endif %}
    
                    <a href="{{ url_for('confirm_delete', delete_type='message', item_id=message.id) }}">Delete</a>
                    
                  </div>
                </div>
                <img src="{{ message.author.create_avatar(128) }}" alt="avatar"
                  class="rounded-circle d-flex align-self-start ms-3 shadow-1-strong" width="60">
              </li>
              
              
              {% else %}
              <li class="d-flex justify-content-between mb-4">
                <img src="{{ message.author.create_avatar(128) }}" alt="avatar"
                  class="rounded-circle d-flex align-self-start me-3 shadow-1-strong" width="60">
                <div class="card {% if not message.is_read and message.recipient_owner_id == current_user.id%}unread{%endif%}" data-message-id="{{message.id}}">
                  <div class="card-header d-flex justify-content-between p-3">
                   Message ID: {{message.id}}
                    <p class="fw-bold mb-0">{{message.author.username}}</p>
                    <p class="small text-muted">{{message.puzzle.title}}</p>
                    <p class="text-muted small mb-0"><i class="far fa-clock"></i> {{message.timestamp}}</p>
                    
                    <div class="pt-1">
                      <!-- <p class="small text-muted mb-1">Just now</p> -->
                      {% if not message.is_read and message.recipient_owner_id == current_user.id%}
                      <span class="unread-indicator badge bg-danger float-end" >unread</span>
                      {%endif%}
                    </div>
                  </div>
                  <div class="card-body">
                    <p class="mb-0">
                      {{message.content}}
                    </p>
                    
                    {%if message.id == last_message_ids[message.puzzle_id] and current_user.id == message.puzzle.user_id and message.puzzle.is_requested %}
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#personalNoteModal" data-action="approve" data-requester="{% if message.author.username == current_user.username %}{{message.recipient.username}}{% else %}{{message.author.username}}{%endif%}" data-puzzle-id="{{ message.puzzle.id }}" >Approve</button>
                    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#personalNoteModal" data-action="decline" data-requester="{% if message.author.username == current_user.username %}{{message.recipient.username}}{% else %}{{message.author.username}}{%endif%}" data-puzzle-id="{{ message.puzzle.id }}" >Decline</button> 
                    {% endif %}
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-delete-type="message" data-item-id={{message.id}}></button>
                    <a href="{{ url_for('confirm_delete', delete_type='message', item_id=message.id) }}">Delete</a>
                  </div>
                </div>
              </li>
              {% endif %}
            {% endfor %}
            {% endif %}
            

            <!-- {% if current_user.username != recipient.username%} -->
            
            <li class="bg-white mb-3">
            </div>  
                <div data-mdb-input-init class="form-outline">
                    <form action="{{ url_for('send_message')}}" enctype="multipart/form-data" method="POST">
                        <textarea class="form-control bg-body-tertiary" name="content" id="content" rows="4" placeholder="Send message to {{recipient.username}}"></textarea>
                        <input type="hidden" name="puzzle_id" value="{{puzzle_id}}">
                        <input type="hidden" name="recipient_id" value="{{ recipient.id }}">
                        <label class="form-label" for="content">Message</label>
                        <button  type="submit" data-mdb-button-init data-mdb-ripple-init class="btn btn-info btn-rounded float-end">Send</button>
                    </form>
                        
                </div>
             
            {% endif %}
             </li>    
     
    {%endif%}
   
         
         
        
              
              
             
              
            </ul>
         
            
           
          </div>
          
    
        </div>
    
      </div>
    
        
     
  </section>

  
  

<script>
    // wait for page to load, get all the elements that have 'data-message-id' attribute
    document.addEventListener('DOMContentLoaded', function() {
        const messageElements = document.querySelectorAll('div[data-message-id]');
        const personalNoteModal = document.getElementById('personalNoteModal')
        
        console.log('help')

        messageElements.forEach(function(messageElement) {
       // how to prevent user from sending fetch request every time they click the the message issue
       // if the message already contains the class 'unread' from the boolean logic in the messages.html
       //    add event listener to each message that has 'unread' class
            
        if (messageElement.classList.contains('unread')) {
            messageElement.addEventListener('click', handleRead);
        }
        
    });
        
        // function to hide unread indicator upon user clicking message 
        function handleRead(event) {
          console.log('success clicked')
            // target is the messageElement
        const messageElement = event.currentTarget;
        const messageId = messageElement.getAttribute('data-message-id');
        fetch('/message/read/' + messageId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            // empty body for POST request
            body: JSON.stringify({})
        
    }).then(function(response) {
            // returns promise that will be result of response as JSON
            // response is built-in object that represents HTTP response from server as JS object
            // allows you to access the response data, headers, status...
            return response.json();
    }).then(function(data){
        // this function will use the JSON object from the response...
        // from the view function in routes file, if the server has marked the message as read if will be status success
        // otherwise, status will be failure 
        if (data.status === 'success') {
            console.log('data status come back success')
            // unread indicator on individual message 
            const unreadIndicator = messageElement.querySelector('.unread-indicator');
            // badge by username of number of unread message(s)
            const unreadCountBadge = document.getElementById('unread-count-badge');
            // need to check if unread indicator element is present first
            // otherwise if it's already been read will cause runtime error (cannot read property 'style' of null because there will be no unread indicator)
            if (unreadIndicator && unreadCountBadge) {
                unreadIndicator.style.display = 'none'
                unreadCountBadge.textContent = data.unread_count
                if (data.unread_count == 0) {
                    unreadCountBadge.style.display = 'none'
                }
            } else {
                console.log("error!!!!!")
            }
          
            // remove unread from the div class
            messageElement.classList.remove('unread');
            // from base.html JS that handles the visibility of the unread count next to messages in nav bar
            // will handle the unread message count - pass in the updated count from the data in the response
            set_message_count(data.unread_count);
            
            } 
            // prevent user from clicking message again and sending fetch requests each time
            messageElement.removeEventListener('click', handleRead);

        }).catch(function(error) {
            console.error('Error:', error);
        })
    
    }     
    
// data attributes for personal note modal
// get the attributes by listening to when user clicks the approve or decline button
    if (personalNoteModal) {
      personalNoteModal.addEventListener('show.bs.modal', function(event) {
        // button that triggers modal
        const button = event.relatedTarget
        // get the data attributes
        const action = button.getAttribute('data-action')
        console.log(action)
        const requester = button.getAttribute('data-requester')
        console.log(requester)
        const puzzleId = button.getAttribute('data-puzzle-id')
        console.log(puzzleId)
        const recipientName = button.getAttribute('data-recipient-name')

      // assign the value to the hidden inputs in the modal whatever the values are from the attributes above
      document.getElementById('actionType').value = action
      document.getElementById('requester').value = requester
      document.getElementById('puzzleId').value = puzzleId
      document.getElementById('recipientName').value = requester
      })
    
   
    }  
});
</script>
    
           
{% endblock %}         

  
 

    
    
    
    
    