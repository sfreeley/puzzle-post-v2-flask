{% extends 'base.html' %}

 {% block content %}
<h1>
    Your Messages, {{current_user.username}}
    puzzle_id:{{puzzle_id}}
    
    
</h1>

<section >
   
    
    <div class="container py-5 ">
  
      <div class="row">
  
        <div class="col-md-6 col-lg-5 col-xl-4 mb-4 mb-md-0">
  
          <h5 class="font-weight-bold mb-3 text-center text-lg-start">Member</h5>
          
          <div class="card ">
            
            <div class="card-body">
                
              <ul class="list-unstyled mb-0">
                {% if message_senders %}
                    {% for message_sender in message_senders %}
                   
                        {% set sender = message_sender.sender %}
                        {% set unread_count = message_sender.unread_count %}
                        {% set most_recent_puzzle_id = message_sender.most_recent_puzzle_id%}
                        
                        
                        {% if not sender.id == current_user.id%}
                        
                <li class="p-2 border-bottom bg-body-tertiary">
                
                  <a href="/messages?recipient_id={{sender.id}}&puzzle_id={%if not puzzle_id %}{{most_recent_puzzle_id}}{%else%}{{puzzle_id}}{% endif %}" class="d-flex justify-content-between">
                    {{most_recent_puzzle_id}}
                    
                    <div class="d-flex flex-row">
                       
                      <img src="{{ sender.create_avatar(128) }}" alt="avatar"
                        class="rounded-circle d-flex align-self-center me-3 shadow-1-strong" width="60">
                      <div class="pt-1">
                        <p class="fw-bold mb-0">{{ sender.username }}</p>
                        <p class="fw-bold mb-0">{{ message_sender.username }}</p>
                        {% if unread_count > 0 %}
                            <span class="badge bg-danger">{{ unread_count }}</span>
                        {% endif %}
                        
                      </div>
                     
                    </div>
                    
                    
                    
                  </a>
                  
                </li>
                        {% endif %}
                {% endfor %}
            {% else %}
                <p>You have no messages yet.</p>
            {% endif %}
                

              </ul>
  
            </div>
          </div>
  
        </div>
    
       
        <div class="col-md-6 col-lg-7 col-xl-8">

            <ul class="list-unstyled">
              
              {% if recipient %}
                {% if conversation %}
                    {% for message in conversation%}
                        {% if message.author.username != current_user.username%}
              <li class="d-flex justify-content-between mb-4">
                <div class="card w-100 {% if not message.is_read and message.recipient_owner_id == current_user.id%}unread{%endif%}" data-message-id="{{message.id}}">
                  <div class="card-header d-flex justify-content-between p-3">
                    <p class="fw-bold mb-0">{{message.author.username}}</p>
                    <p class="small text-muted">{{message.puzzle.title}}</p>
                    <p class="text-muted small mb-0"><i class="far fa-clock"></i> {{message.timestamp}}</p>
                    
                    <div class="pt-1">
                        <!-- <p class="small text-muted mb-1">Just now</p> -->
                      {% if not message.is_read and message.recipient_owner_id == current_user.id%}
                      <span class="unread-indicator badge bg-danger float-end">unread</span>
                      {%endif%}
                    </div>
                  </div>
                  <div class="card-body">
                    <p class="mb-0">
                      {{message.content}}
                    </p>
                    
                   
                    {%if loop.last and current_user.id == message.puzzle.user_id and message.puzzle.is_requested %}
                    <a href="{{ url_for('request_action', action='approve', requester=message.author.username, puzzle_id=message.puzzle.id) }}">Approve</a>
                    <a href="{{ url_for('request_action', action='decline', requester=message.author.username, puzzle_id=message.puzzle.id) }}">Decline</a>
                    {% endif %}
    
                    <a href="{{ url_for('confirm_delete', delete_type='message', item_id=message.id) }}">Delete</a>
                    
                  </div>
                </div>
                <img src="{{ message.author.create_avatar(128) }}" alt="avatar"
                  class="rounded-circle d-flex align-self-start ms-3 shadow-1-strong" width="60">
              </li>
              
              
              {% else %}
              <li class="d-flex justify-content-between mb-4">
                <img src="{{ message.author.create_avatar(128) }}" alt="avatar"
                  class="rounded-circle d-flex align-self-start me-3 shadow-1-strong" width="60">
                <div class="card {% if not message.is_read and message.recipient_owner_id == current_user.id%}unread{%endif%}" data-message-id="{{message.id}}">
                  <div class="card-header d-flex justify-content-between p-3">
                    <p class="fw-bold mb-0">{{message.author.username}}</p>
                    <p class="small text-muted">{{message.puzzle.title}}</p>
                    <p class="text-muted small mb-0"><i class="far fa-clock"></i> {{message.timestamp}}</p>
                    
                    <div class="pt-1">
                      <!-- <p class="small text-muted mb-1">Just now</p> -->
                      {% if not message.is_read and message.recipient_owner_id == current_user.id%}
                      <span class="unread-indicator badge bg-danger float-end" >umread</span>
                      {%endif%}
                    </div>
                  </div>
                  <div class="card-body">
                    <p class="mb-0">
                      {{message.content}}
                    </p>
                    {%if loop.last and current_user.id == message.puzzle.user_id and message.puzzle.is_requested %}
                    <a href="{{ url_for('request_action', action='approve', requester=message.author.username, puzzle_id=message.puzzle.id) }}">Approve</a>
                    <a href="{{ url_for('request_action', action='decline', requester=message.author.username, puzzle_id=message.puzzle.id) }}">Decline</a>
                    {% endif %}
                    <a href="{{ url_for('confirm_delete', delete_type='message', item_id=message.id) }}">Delete</a>
                  </div>
                </div>
              </li>
              {% endif %}
            {% endfor %}
            {% endif %}

            {% if current_user.username != recipient.username%}
            
            <li class="bg-white mb-3">
                
                <div data-mdb-input-init class="form-outline">
                    <form action="{{ url_for('send_message')}}" enctype="multipart/form-data" method="POST">
                        <textarea class="form-control bg-body-tertiary" name="content" id="content" rows="4" placeholder="Send message to {{recipient.username}}"></textarea>
                        <input type="hidden" name="puzzle_id" value="{% if not puzzle_id%} {{most_recent_puzzle_id}}{%else%} {{puzzle_id}} {%endif%}">
                        <input type="hidden" name="recipient_id" value="{{ recipient.id }}">
                        <label class="form-label" for="content">Message</label>
                        <button  type="submit" data-mdb-button-init data-mdb-ripple-init class="btn btn-info btn-rounded float-end">Send</button>
                    </form>
                        
                </div>
            {% endif %}
             </li>    
        {%else%}
              {% if recipient %}
            <p>No conversations between you and {{recipient.username}}. Let's start one.</p> 
            <div data-mdb-input-init class="form-outline">
                <form action="{{ url_for('send_message')}}" enctype="multipart/form-data" method="POST">
                    <textarea class="form-control bg-body-tertiary" name="content" id="content" rows="4" placeholder="Send message to {{recipient.username}}"></textarea>
                    <input type="hidden" name="puzzle_id" value="{{ puzzle_id }}">
                    <input type="hidden" name="recipient_id" value="{{ recipient.id }}">
                    <label class="form-label" for="content">Message</label>
                    <button  type="submit" data-mdb-button-init data-mdb-ripple-init class="btn btn-info btn-rounded float-end">Send</button>
                </form>
                    
            </div>
              
            {% endif %}
    {%endif%}
   
         
         
        
              
              
             
              
            </ul>
         
            
           
          </div>
          
    
        </div>
    
      </div>
    
        
     
  </section>

  
  

<script>
    // wait for page to load, get all the elements that have 'data-message-id' attribute
    document.addEventListener('DOMContentLoaded', function() {
        const messageElements = document.querySelectorAll('div[data-message-id]');
        messageElements.forEach(function(messageElement) {
       // how to prevent user from sending fetch request every time they click the the message issue
       // if the message already contains the class 'unread' from the boolean logic in the messages.html
       //    add event listener to each message that has 'unread' class
            
        if (messageElement.classList.contains('unread')) {
            messageElement.addEventListener('click', handleRead);
        }
    });
        
        // function to hide unread indicator upon user clicking message 
        function handleRead(event) {
            // target is the messageElement
        const messageElement = event.currentTarget;
        const messageId = this.getAttribute('data-message-id');
        fetch('/message/read/' + messageId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            // empty body for POST request
            body: JSON.stringify({})
        
    }).then(function(response) {
            // returns promise that will be result of response as JSON
            // response is built-in object that represents HTTP response from server as JS object
            // allows you to access the response data, headers, status...
            return response.json();
    }).then(function(data){
        // this function will use the JSON object from the response...
        // from the view function in routes file, if the server has marked the message as read if will be status success
        // otherwise, status will be failure 
        if (data.status === 'success') {
            console.log('data status come back success')
            var unreadIndicator = messageElement.querySelector('.unread-indicator');
            // need to check if unread indicator element is present first
            // otherwise if it's already been read will cause runtime error (cannot read property 'style' of null because there will be no unread indicator)
            if (unreadIndicator) {
                unreadIndicator.style.display = 'none'
            } else {

                console.log("error- did not remove unread indicator")
            }
          
            // remove unread from the div class
            messageElement.classList.remove('unread');
            // from base.html JS that handles the visibility of the unread count next to messages in nav bar
            // will handle the unread message count - pass in the updated count from the data in the response
            set_message_count(data.unread_count);
            
            } 
            // prevent user from clicking message again and sending fetch requests each time
            messageElement.removeEventListener('click', handleRead);

        }).catch(function(error) {
            console.error('Error:', error);
        })
    
    }     
    


});
</script>
    
           
{% endblock %}         

  
 

    
    
    
    
    